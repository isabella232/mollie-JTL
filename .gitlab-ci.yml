image: registry.webstollen.com:443/docker/jtl-plugin-ci:master

stages:
  - test
  - build
  - finalize
  - publish

sast:
  stage: test
include:
- template: Security/SAST.gitlab-ci.yml

phpunit:
  image: registry.webstollen.com:443/docker/jtl-plugin-ci:php56
  stage: test
  only:
    - tags
    - master
  script:
    - if [ -f "phpunit.xml" ]; then composer install -o && ./vendor/bin/phpunit; else echo "Skipped PHPUnit, no phpunit.xml"; fi


composer:
  stage: build
  only:
    - tags
    - master
  cache:
    key:
      files:
        - composer.lock
    paths:
      - vendor
    policy: pull
  script:
    - if [ -f "composer.json" ]; then composer install --no-dev -o; else echo "Skipped Composer, no composer.json"; fi
  artifacts:
    expire_in: 3 days
    untracked: true

node:
  stage: build
  only:
    - tags
    - master
  cache:
    key:
      files:
        - adminmenu/app/yarn.lock
    paths:
      - adminmenu/app/node_modules
      - adminmenu/app/.yarn-cache
    policy: pull
  script:
    - npm config set "@fortawesome:registry" https://npm.fontawesome.com/
    - npm config set "//npm.fontawesome.com/:_authToken" $FONT_AWESOME_TOKEN
    - npm config set "@dash.bar:registry" https://gitlab.webstollen.com/api/v4/packages/npm/
    - npm config set "@webstollen:registry" https://gitlab.webstollen.com/api/v4/packages/npm/
    - npm config set "//gitlab.webstollen.com/api/v4/packages/npm/:_authToken" $CI_JOB_TOKEN
    - npm config set "//gitlab.webstollen.com/api/v4/projects/444/packages/npm/:_authToken"
      $CI_JOB_TOKEN
    - if [ -f "adminmenu/app/package.json" ]; then cd adminmenu/app && yarn install --frozen-lockfile --cache-folder .yarn-cache && yarn build; else echo "Skipped Yarn build, no packages.json"; fi
  artifacts:
    expire_in: 3 days
    untracked: false
    paths:
      - adminmenu/app/build

pack:
  stage: finalize
  only:
    - tags
    - master
  script:
    - rm -rf .git/ adminmenu/app/src/ adminmenu/app/test/ adminmenu/app/public/ tests/
    - rm -f .gitlab-ci.yml phpunit.xml adminmenu/app/*.js* adminmenu/app/yarn.lock adminmenu/app/README.md adminmenu/cra.sh
    - cd ..
    - if [ $SKIP_COMPILE = 1 ]; then echo "Skipped Compiler!"; else compiler $CI_PROJECT_DIR $CI_PROJECT_DIR; fi
    - zip -r $CI_PROJECT_DIR/$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME.zip $CI_PROJECT_NAME
  artifacts:
    expire_in: 30 days
    paths:
      - $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME.zip

upload:
  stage: publish
  only:
    - tags
    - master
  script:
    - aws configure set region eu-central-1
    - if [ $SKIP_COMPILE = 1 ]; then export SRC_PREFIX="-src"; fi
    - aws s3 cp $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME.zip s3://$S3_BUCKET/jtl-plugins/$CI_PROJECT_NAME/$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME$SRC_PREFIX.zip