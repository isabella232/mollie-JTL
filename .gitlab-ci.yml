# You can override the included template(s) by including variable overrides
# See https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#priority-of-environment-variables

# S3_BUCKET
#  AWS_ACCESS_KEY_ID	Your Access key ID
#  AWS_SECRET_ACCESS_KEY	Your Secret access key
#  AWS_DEFAULT_REGION
#upload to s3:
#  image:
#    name: banst/awscli
#    entrypoint: [""]
#  script:
#    - aws configure set region us-east-1
#    - touch foo.txt
#    - aws s3 cp foo.txt s3://$S3_BUCKET/foo.txt

image: registry.webstollen.com:443/docker/jtl-plugin-ci:master

stages:
  - test
  - build
  - finalize
  - publish

sast:
  stage: test
include:
- template: Security/SAST.gitlab-ci.yml


composer:
  stage: build
#  only:
#    - tags
#    - master
  cache:
    key:
      files:
        - composer.lock
    paths:
      - vendor
    policy: pull
  script:
    - composer install --no-dev -o
  artifacts:
    expire_in: 3 days
    untracked: true

pack:
  stage: finalize
#  only:
#    - tags
#    - master
  script:
    - rm -rf .gitlab-ci.yml .git/
    - cd ..
    - compiler $CI_PROJECT_DIR $CI_PROJECT_DIR
    - zip -r $CI_PROJECT_DIR/$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME.zip $CI_PROJECT_NAME
  artifacts:
    expire_in: 30 days
    paths:
      - $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME.zip

upload:
  stage: publish
  script:
    - aws configure set region eu-central-1
    #- echo $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME.zip
    #- echo $CI_PROJECT_DIR
    #- echo $CI_PROJECT_NAME
    - aws s3 cp $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME.zip s3://$S3_BUCKET/jtl-plugins/$CI_PROJECT_NAME/$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME.zip